<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BenMark - Resumen de Tesorer铆a</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/page-protection.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <img src="../images/logo-benmarket.jpg" alt="BenMarket" class="navbar-logo">
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Ingresos</a></li>
                <li><a href="egresosCaja.html" class="nav-link">Egresos</a></li>
                <li><a href="operaciones.html" class="nav-link">Operaciones</a></li>
                <li><a href="arqueo.html" class="nav-link">Arqueo de Caja</a></li>
                <li><a href="resumen.html" class="nav-link activo">Resumen</a></li>
                <li id="nav-usuarios"><a href="usuarios.html" class="nav-link">Usuarios</a></li>
            </ul>
            <div class="nav-usuario">
                <span id="nombreUsuarioNav"></span>
                <a href="#" onclick="event.preventDefault(); cerrarSesion()" class="nav-link-logout">Cerrar Sesi贸n</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <!-- Secci贸n de Resumen -->
        <section id="resumen" class="seccion activa">
            <h2>Resumen de Tesorer铆a</h2>

            <!-- **NUEVO:** Dashboard de M茅tricas -->
            <div class="dashboard-metrics">
                <div class="metric-card metric-efectivo">
                    <div class="metric-icon"></div>
                    <div class="metric-content">
                        <div class="metric-label">Total Efectivo</div>
                        <div class="metric-value" id="metricTotalEfectivo">G$ 0</div>
                        <div class="metric-subtitle">Pagos en efectivo</div>
                    </div>
                </div>

                <div class="metric-card metric-tarjeta">
                    <div class="metric-icon"></div>
                    <div class="metric-content">
                        <div class="metric-label">Total Tarjeta</div>
                        <div class="metric-value" id="metricTotalTarjeta">G$ 0</div>
                        <div class="metric-subtitle">Pagos con tarjeta</div>
                    </div>
                </div>

                <div class="metric-card metric-credito">
                    <div class="metric-icon"></div>
                    <div class="metric-content">
                        <div class="metric-label">Total Cr茅dito</div>
                        <div class="metric-value" id="metricTotalCredito">G$ 0</div>
                        <div class="metric-subtitle">Ventas a cr茅dito</div>
                    </div>
                </div>

                <div class="metric-card metric-caja">
                    <div class="metric-icon"></div>
                    <div class="metric-content">
                        <div class="metric-label">Caja Destacada</div>
                        <div class="metric-value" id="metricCajaDestacada">-</div>
                        <div class="metric-subtitle" id="metricCajaDetalle">Mayor actividad</div>
                    </div>
                </div>
            </div>
            <div class="resumen-filtros">
                <div class="form-grupo">
                    <label for="fechaResumenDesde">Desde:</label>
                    <input type="date" id="fechaResumenDesde" onchange="cargarResumenDiario()">
                </div>
                <div class="form-grupo">
                    <label for="fechaResumenHasta">Hasta:</label>
                    <input type="date" id="fechaResumenHasta" onchange="cargarResumenDiario()">
                </div>
                <div class="form-grupo">
                    <label for="filtroCajaGeneral">Caja:</label>
                    <select id="filtroCajaGeneral" onchange="aplicarFiltroCajaGeneral()">
                        <option value="">Todas las Cajas</option>
                        <option value="Caja 1">Caja 1</option>
                        <option value="Caja 2">Caja 2</option>
                        <option value="Caja 3">Caja 3</option>
                    </select>
                </div>
                <div class="resumen-botones-excel">
                    <button class="btn btn-excel" onclick="descargarExcel()">Exportar Resumen</button>
                    <button class="btn btn-excel" onclick="exportarHistorialArqueosExcel()">Exportar Arqueos</button>
                </div>
            </div>

            <!-- **NUEVO:** Estructura de tres columnas -->
            <div class="resumen-columnas">
                <!-- Columna Principal de Ingresos -->
                <section class="resumen-card-principal" id="cardTotalIngresos">
                    <div class="reporte-header-principal" onclick="toggleReporte(this)">
                        <h3 class="titulo-columna">INGRESOS</h3>
                        <span id="totalGeneralIngresos" class="reporte-total-principal positivo"></span>
                    </div>
                    <div class="reporte-contenido" style="display: none;">
                        <!-- **NUEVO:** Saldo en Caja D铆a Anterior -->
                        <section class="resumen-card sub-seccion" id="cardSaldoDiaAnterior">
                            <div class="reporte-header" onclick="toggleReporte(this)">
                                <h3 class="reporte-titulo">Saldo en Caja D铆a Anterior</h3>
                                <span id="totalSaldoDiaAnterior" class="reporte-total positivo"></span>
                            </div>
                            <div class="reporte-contenido" style="display: none;">
                                <div class="filtros-historial">
                                    <select id="filtroCajaSaldoAnterior" onchange="cargarResumenDiario()">
                                        <option value="">Todas las Cajas</option>
                                        <option value="Caja 1">Caja 1</option>
                                        <option value="Caja 2">Caja 2</option>
                                        <option value="Caja 3">Caja 3</option>
                                    </select>
                                </div>
                                <div id="detalleSaldoDiaAnterior" class="lista-movimientos-reporte"></div>
                            </div>
                        </section>

                        <!-- **NUEVO:** Sub-secci贸n para Ingresos en Efectivo -->
                        <section class="resumen-card sub-seccion" id="cardIngresosEfectivo">
                            <div class="reporte-header" onclick="toggleReporte(this)">
                                <h3 class="reporte-titulo">Ingresos en Efectivo</h3>
                                <span id="totalIngresosEfectivo" class="reporte-total positivo"></span>
                            </div>
                            <div class="reporte-contenido" style="display: none;">
                                <section class="resumen-card" id="cardIngresosTienda">
                                    <div class="reporte-header" onclick="toggleReporte(this)">
                                        <h3 class="reporte-titulo">Ingresos de Tienda (Solo Efectivo)</h3>
                                        <span id="totalIngresosTienda" class="reporte-total"></span>
                                    </div>
                                    <div class="reporte-contenido" style="display: none;">
                                        <div class="filtros-historial">
                                            <select id="filtroCajaIngresosTienda" onchange="cargarResumenDiario()">
                                                <option value="">Todas las Cajas</option>
                                                <option value="Caja 1">Caja 1</option>
                                                <option value="Caja 2">Caja 2</option>
                                                <option value="Caja 3">Caja 3</option>
                                            </select>
                                            <input type="text" id="filtroDescIngresosTienda"
                                                placeholder="Filtrar por descripci贸n..."
                                                oninput="cargarResumenDiario()">
                                        </div>
                                        <div id="listaIngresosTienda" class="lista-movimientos-reporte"></div>
                                    </div>
                                </section>
                                <section class="resumen-card" id="cardIngresosServiciosEfectivo">
                                    <div class="reporte-header" onclick="toggleReporte(this)">
                                        <h3 class="reporte-titulo">Ingresos por Servicios (Efectivo)</h3>
                                        <span id="totalIngresosServiciosEfectivo" class="reporte-total"></span>
                                    </div>
                                    <div class="reporte-contenido" style="display: none;">
                                        <div class="filtros-historial">
                                            <select id="filtroCajaServiciosEfectivo" onchange="cargarResumenDiario()">
                                                <option value="">Todas las Cajas</option>
                                                <option value="Caja 1">Caja 1</option>
                                                <option value="Caja 2">Caja 2</option>
                                                <option value="Caja 3">Caja 3</option>
                                            </select>
                                            <input type="text" id="filtroNombreServicioEfectivo"
                                                placeholder="Filtrar por servicio..." oninput="cargarResumenDiario()">
                                        </div>
                                        <div id="listaIngresosServiciosEfectivo" class="lista-movimientos-reporte">
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </section>

                        <!-- **NUEVO:** Sub-secci贸n para Dep贸sitos - Inversiones -->
                        <section class="resumen-card sub-seccion" id="cardDepositosInversionesGeneral">
                            <div class="reporte-header" onclick="toggleReporte(this)">
                                <h3 class="reporte-titulo">Dep贸sitos - Inversiones</h3>
                                <span id="totalDepositosInversionesGeneral" class="reporte-total positivo"></span>
                            </div>
                            <div class="reporte-contenido" style="display: none;">
                                <section class="resumen-card" id="cardDepositosInversiones">
                                    <div class="reporte-header" onclick="toggleReporte(this)">
                                        <h3 class="reporte-titulo">Detalle de Dep贸sitos</h3>
                                        <span id="totalDepositosInversiones" class="reporte-total"></span>
                                    </div>
                                    <div class="reporte-contenido" style="display: none;">
                                        <div class="filtros-historial">
                                            <select id="filtroCajaDepositosInversiones"
                                                onchange="cargarResumenDiario()">
                                                <option value="">Todas las Cajas</option>
                                                <option value="Caja 1">Caja 1</option>
                                                <option value="Caja 2">Caja 2</option>
                                                <option value="Caja 3">Caja 3</option>
                                            </select>
                                            <input type="text" id="filtroDescDepositosInversiones"
                                                placeholder="Filtrar por descripci贸n..."
                                                oninput="cargarResumenDiario()">
                                        </div>
                                        <div id="listaDepositosInversiones" class="lista-movimientos-reporte">
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </section>

                        <!-- **NUEVO:** Sub-secci贸n para Ingresos No Efectivo -->
                        <section class="resumen-card sub-seccion" id="cardIngresosNoEfectivoGeneral">
                            <div class="reporte-header" onclick="toggleReporte(this)">
                                <h3 class="reporte-titulo">Ingresos No Efectivo</h3>
                                <span id="totalIngresosNoEfectivoGeneral" class="reporte-total positivo"></span>
                            </div>
                            <div class="reporte-contenido" style="display: none;">
                                <section class="resumen-card" id="cardIngresosServiciosTarjeta">
                                    <div class="reporte-header" onclick="toggleReporte(this)">
                                        <h3 class="reporte-titulo">Ingresos por Servicios (Tarjeta)</h3>
                                        <span id="totalIngresosServiciosTarjeta" class="reporte-total"></span>
                                    </div>
                                    <div class="reporte-contenido" style="display: none;">
                                        <div class="filtros-historial">
                                            <select id="filtroCajaServiciosTarjeta" onchange="cargarResumenDiario()">
                                                <option value="">Todas las Cajas</option>
                                                <option value="Caja 1">Caja 1</option>
                                                <option value="Caja 2">Caja 2</option>
                                                <option value="Caja 3">Caja 3</option>
                                            </select>
                                            <input type="text" id="filtroNombreServicioTarjeta"
                                                placeholder="Filtrar por servicio..." oninput="cargarResumenDiario()">
                                        </div>
                                        <div id="listaIngresosServiciosTarjeta" class="lista-movimientos-reporte"></div>
                                    </div>
                                </section>
                                <section class="resumen-card" id="cardIngresosNoEfectivo">
                                    <div class="reporte-header" onclick="toggleReporte(this)">
                                        <h3 class="reporte-titulo">Otros Ingresos No Efectivo</h3>
                                        <span id="totalIngresosNoEfectivo" class="reporte-total"></span>
                                    </div>
                                    <div class="reporte-contenido" style="display: none;">
                                        <div class="filtros-historial">
                                            <select id="filtroCajaNoEfectivo" onchange="cargarResumenDiario()">
                                                <option value="">Todas las Cajas</option>
                                                <option value="Caja 1">Caja 1</option>
                                                <option value="Caja 2">Caja 2</option>
                                                <option value="Caja 3">Caja 3</option>
                                            </select>
                                            <input type="text" id="filtroDescNoEfectivo"
                                                placeholder="Filtrar por descripci贸n..."
                                                oninput="cargarResumenDiario()">
                                        </div>
                                        <div id="listaIngresosNoEfectivo" class="lista-movimientos-reporte"></div>
                                    </div>
                                </section>
                            </div>
                        </section>
                    </div>
                </section>

                <!-- Columna Principal de Egresos -->
                <section class="resumen-card-principal" id="cardTotalEgresos">
                    <div class="reporte-header-principal" onclick="toggleReporte(this)">
                        <h3 class="titulo-columna" style="color: var(--color-peligro);">EGRESOS</h3>
                        <span id="totalGeneralEgresos" class="reporte-total-principal negativo"></span>
                    </div>
                    <div class="reporte-contenido" style="display: none;">
                        <!-- Aqu铆 van las sub-secciones de egresos -->
                        <section class="resumen-card" id="cardEgresos">
                            <div class="reporte-header" onclick="toggleReporte(this)">
                                <h3 class="reporte-titulo" style="color: var(--color-peligro);">Egresos de Caja</h3>
                                <span id="totalEgresos" class="reporte-total negativo"></span>
                            </div>
                            <div class="reporte-contenido" style="display: none;">
                                <div class="filtros-historial">
                                    <select id="filtroCajaEgresos" onchange="cargarResumenDiario()">
                                        <option value="">Todas las Cajas</option>
                                        <option value="Caja 1">Caja 1</option>
                                        <option value="Caja 2">Caja 2</option>
                                        <option value="Caja 3">Caja 3</option>
                                    </select>
                                    <input type="text" id="filtroDescEgresos" placeholder="Filtrar por descripci贸n..."
                                        oninput="cargarResumenDiario()">
                                </div>
                                <div id="listaEgresos" class="lista-movimientos-reporte"></div>
                            </div>
                        </section>
                        <!-- **NUEVO:** Sub-secci贸n para Egresos de Tesorer铆a (Operaciones) -->
                        <section class="resumen-card" id="cardEgresosTesoreria">
                            <div class="reporte-header" onclick="toggleReporte(this)">
                                <h3 class="reporte-titulo" style="color: var(--color-peligro);">Egresos Tesorer铆a</h3>
                                <span id="totalEgresosTesoreria" class="reporte-total negativo"></span>
                            </div>
                            <div class="reporte-contenido" style="display: none;">
                                <div class="filtros-historial">
                                    <select id="filtroCajaEgresosTesoreria" onchange="cargarResumenDiario()">
                                        <option value="">Todas las Cajas</option>
                                        <option value="Caja 1">Caja 1</option>
                                        <option value="Caja 2">Caja 2</option>
                                        <option value="Caja 3">Caja 3</option>
                                    </select>
                                    <input type="text" id="filtroDescEgresosTesoreria"
                                        placeholder="Filtrar por descripci贸n..." oninput="cargarResumenDiario()">
                                </div>
                                <div id="listaEgresosTesoreria" class="lista-movimientos-reporte"></div>
                            </div>
                        </section>
                    </div>
                </section>

                <!-- Columna de Diferencia -->
                <section class="resumen-card-principal" id="cardDiferencia">
                    <div class="reporte-header-principal" onclick="toggleReporte(this)">
                        <h3 class="titulo-columna" style="color: var(--color-info);">SALDOS</h3>
                        <span id="totalDiferencia" class="reporte-total-principal"></span>
                    </div>
                    <div class="reporte-contenido" style="display: none;">
                        <div class="resumen-totales" style="padding-top: 1rem;">
                            <div class="total-item" id="itemDiferenciaEfectivo">
                                <span>Total Efectivo en Caja:</span>
                                <strong id="diferenciaEfectivo"></strong>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- **CORRECCIN:** Cargar app.js PRIMERO, antes de llamar a las funciones -->
    <script src="../js/app.js"></script>
    <script src="../js/resumen-metrics.js"></script>
    <script>
        if (window.inicializarSupabase) { window.inicializarSupabase(); }
        if (window.initSupabaseData) { window.initSupabaseData(); }

        // Inicializar m茅tricas cuando se carga la p谩gina
        window.addEventListener('DOMContentLoaded', function () {
            if (typeof window.actualizarMetricasResumen === 'function') {
                // Esperar un momento para que los datos se carguen
                setTimeout(() => {
                    window.actualizarMetricasResumen();
                }, 500);
            }
        });
    </script>
</body>

</html>