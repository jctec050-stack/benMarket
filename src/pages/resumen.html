<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BenMark - Resumen de Tesorer√≠a</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/page-protection.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <img src="../images/logo-benmarket.jpg" alt="BenMarket" class="navbar-logo">
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Ingresos</a></li>
                <li><a href="egresosCaja.html" class="nav-link">Egresos</a></li>
                <li><a href="operaciones.html" class="nav-link">Operaciones</a></li>
                <li><a href="arqueo.html" class="nav-link">Arqueo de Caja</a></li>
                <li><a href="resumenServicios.html" class="nav-link">Resumen Servicios</a></li>
                <li><a href="resumen.html" class="nav-link activo">Resumen Tesoreria</a></li>
                <li id="nav-usuarios"><a href="usuarios.html" class="nav-link">Usuarios</a></li>
            </ul>
            <div class="nav-usuario">
                <span id="nombreUsuarioNav"></span>
                <a href="#" onclick="event.preventDefault(); cerrarSesion()" class="nav-link-logout">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <!-- Secci√≥n de Resumen -->
        <section id="resumen" class="seccion activa">


            <!-- **NUEVO:** Dashboard de M√©tricas -->
            <div class="resumen-filtros">
                <div class="form-grupo">
                    <label for="fechaResumenDesde">Desde:</label>
                    <input type="date" id="fechaResumenDesde"
                        onchange="cargarResumenDiario(); cargarTablaPagosEgresos(); cargarTablaIngresosEgresos()">
                </div>
                <div class="form-grupo">
                    <label for="fechaResumenHasta">Hasta:</label>
                    <input type="date" id="fechaResumenHasta"
                        onchange="cargarResumenDiario(); cargarTablaPagosEgresos(); cargarTablaIngresosEgresos()">
                </div>
                <div class="form-grupo">
                    <label for="filtroCajaGeneral">Caja:</label>
                    <select id="filtroCajaGeneral" onchange="aplicarFiltroCajaGeneral()">
                        <option value="">Todas las Cajas</option>
                        <option value="Caja 1">Caja 1</option>
                        <option value="Caja 2">Caja 2</option>
                        <option value="Caja 3">Caja 3</option>
                        <option value="Tesoreria">Tesoreria</option>
                    </select>
                </div>
            </div>

            <!-- **NUEVO:** Dashboard de M√©tricas -->
            <div class="dashboard-metrics">
                <!-- 1. Total Tarjeta -->
                <div class="metric-card metric-tarjeta">
                    <div class="metric-icon">üí≥</div>
                    <div class="metric-content">
                        <div class="metric-label">Total Tarjeta</div>
                        <div class="metric-value" id="metricTotalTarjeta">G$ 0</div>
                        <div class="metric-subtitle">Pagos con tarjeta</div>
                    </div>
                </div>

                <!-- 2. Pedidos Ya -->
                <div class="metric-card metric-pedidosya">
                    <div class="metric-icon">üõµ</div>
                    <div class="metric-content">
                        <div class="metric-label">Pedidos Ya</div>
                        <div class="metric-value" id="metricTotalPedidosYa">G$ 0</div>
                        <div class="metric-subtitle">Ventas por app</div>
                    </div>
                </div>

                <!-- 3. Ventas a Cr√©dito -->
                <div class="metric-card metric-credito">
                    <div class="metric-icon">üìù</div>
                    <div class="metric-content">
                        <div class="metric-label">Ventas a Credito</div>
                        <div class="metric-value" id="metricTotalCredito">G$ 0</div>
                        <div class="metric-subtitle">Ventas a cr√©dito</div>
                    </div>
                </div>


            </div>

            <!-- Seccion Recaudacion -->
            <div class="recaudacion-section">
                <h2 class="section-title text-center">RECAUDACION</h2>
                <div class="table-responsive">
                    <table class="tabla-recaudacion" id="tablaRecaudacion">
                        <thead>
                            <tr>
                                <th>CAJERO</th>
                                <th>Total Ingresos Tienda</th>
                                <th>EFECTIVO</th>
                                <th>SOBRANTE</th>
                                <th>FALTANTE</th>
                                <th>SubTotales/user</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyRecaudacion">
                        </tbody>
                        <tfoot id="tfootRecaudacion">
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Seccion Pagos/Egresos -->
            <div class="recaudacion-section" style="margin-top: 2rem;">
                <h2 class="section-title text-center">PAGOS / EGRESOS</h2>
                <div class="table-responsive">
                    <table class="tabla-recaudacion" id="tablaPagosEgresos">
                        <thead>
                            <tr>
                                <th>CAJERO</th>
                                <th>CATEGOR√çA</th>
                                <th>DESCRIPCI√ìN</th>
                                <th>MONTO</th>
                            </tr>
                            <!-- Filtros por columna -->
                            <tr class="filter-row" style="background-color: #f8fafc;">
                                <th style="padding: 5px;"><input type="text" id="filtroPagoCajero"
                                        onkeyup="cargarTablaPagosEgresos()" placeholder="Filtrar..."
                                        style="width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 4px; font-weight: normal;">
                                </th>
                                <th style="padding: 5px;"><input type="text" id="filtroPagoCategoria"
                                        onkeyup="cargarTablaPagosEgresos()" placeholder="Filtrar..."
                                        style="width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 4px; font-weight: normal;">
                                </th>
                                <th style="padding: 5px;"><input type="text" id="filtroPagoDescripcion"
                                        onkeyup="cargarTablaPagosEgresos()" placeholder="Filtrar..."
                                        style="width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 4px; font-weight: normal;">
                                </th>
                                <th style="padding: 5px;"><input type="number" id="filtroPagoMonto"
                                        onkeyup="cargarTablaPagosEgresos()" placeholder="Min..."
                                        style="width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 4px; font-weight: normal;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tbodyPagosEgresos">
                        </tbody>
                        <tfoot id="tfootPagosEgresos">
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Seccion Ingresos/Egresos Detallado -->
            <div class="recaudacion-section" style="margin-top: 2rem;">
                <div class="table-responsive">
                    <table class="tabla-ingresos-egresos" id="tablaIngresosEgresos">
                        <thead>
                            <tr>
                                <th style="width: 50%;">INGRESOS</th>
                                <th style="width: 50%;">EGRESOS</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyIngresosEgresos">
                            <!-- Se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bot√≥n de Exportar a Excel -->
            <div style="text-align: center; margin-top: 2rem;">
                <button id="btnExportarExcel" class="btn-exportar" onclick="exportarResumenAExcel()">
                    üìä Exportar a Excel
                </button>
            </div>

        </section>
    </main>

    <!-- Modal de Detalle de M√©tricas -->
    <div id="modalDetalleMetrica" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModalMetrica()">&times;</span>
            <h2 id="tituloModalMetrica">Detalle de Movimientos</h2>
            <div class="table-responsive">
                <table class="tabla-recaudacion">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cajero</th>
                            <th>Caja</th>
                            <th>Descripci√≥n</th>
                            <th>Monto</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDetalleMetrica">
                    </tbody>
                </table>
            </div>
            <!-- Total en el modal -->
            <div class="resumen-totales"
                style="margin-top: 1rem; border-top: 1px solid var(--color-borde); padding-top: 1rem;">
                <div class="total-item final">
                    <span>Total:</span>
                    <span id="totalModalMetrica">G$ 0</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- **CORRECCI√ìN:** Cargar app.js PRIMERO, antes de llamar a las funciones -->
    <script src="../js/benmark.js"></script>
    <script src="../js/export-excel.js"></script>
    <script src="../js/resumen-metrics.js"></script>
    <script>
        if (window.inicializarSupabase) { window.inicializarSupabase(); }
        if (window.initSupabaseData) { window.initSupabaseData(); }

        // Inicializar m√©tricas cuando se carga la p√°gina
        window.addEventListener('DOMContentLoaded', function () {
            if (typeof window.actualizarMetricasResumen === 'function') {
                // Esperar un momento para que los datos se carguen
                setTimeout(() => {
                    window.actualizarMetricasResumen();
                }, 500);
                setTimeout(() => { if (window.cargarTablaPagosEgresos) window.cargarTablaPagosEgresos(); }, 600);
                setTimeout(() => { if (window.cargarTablaIngresosEgresos) window.cargarTablaIngresosEgresos(); }, 700);
            }
        });
    </script>
</body>

</html>